<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cargo Pilot Auto Waypoint</title>
<style>
body { margin:0; font-family:"Segoe UI", sans-serif; background:transparent; color:white; }
#cargoOverlay {
  position:fixed; top:10px; right:10px;
  background:rgba(0,0,0,0.7); padding:10px 15px;
  border-radius:8px; font-size:14px; z-index:9999;
  pointer-events:none;
  transition: opacity 0.3s ease;
}
#version { position:fixed; bottom:10px; right:10px; color:white; font-size:12px; }
</style>
</head>
<body>
<div id="cargoOverlay">Waiting for cargo notifications...</div>
<div id="version">v1.5</div>

<script>
// ================================
// AUTO CACHE-BUST
// ================================
(function() {
  const url = new URL(window.location.href);
  if (!url.searchParams.has("v")) {
    url.searchParams.set("v", Date.now());
    window.location.replace(url.toString());
  }
})();

// ================================
// AIRPORT COORDINATES
// ================================
const airports = {
  LSIA:{x:-1034.60,y:-2733.60,z:13.76,name:"LSIA Deliver Cargo"},
  SSIA:{x:1743.68,y:3286.25,z:41.08,name:"SSIA Deliver Cargo"},
  SCA:{x:1723.30,y:3254.85,z:41.10,name:"SCA Deliver Cargo"},
  ZMA:{x:-2444.02,y:3126.47,z:32.81,name:"Zancudo Deliver Cargo"},
  CIA:{x:-5339.27,y:913.45,z:12.00,name:"Chumash Deliver Cargo"},
  POP:{x:997.18,y:-3415.91,z:4.70,name:"PostOP Deliver Cargo"},
  POA:{x:3008.46,y:-716.60,z:19.44,name:"Pacific Ocean Deliver Cargo"},
  MGA:{x:2951.19,y:-1063.45,z:18.59,name:"Mount Gordo Deliver Cargo"}
};

// ================================
// UI UPDATE
// ================================
const overlay = document.getElementById('cargoOverlay');
function updateOverlay(cargoName, airportName){
  overlay.innerHTML = cargoName
    ? `Cargo: <b>${cargoName}</b><br>Next: <b>${airportName || 'Unknown'}</b>`
    : 'Waiting for cargo notifications...';
  overlay.style.opacity = 1;
  setTimeout(()=>{ overlay.style.opacity = 0.7; }, 5000);
}

// ================================
// TRACK LAST PROCESSED CARGO & WAYPOINT STATE
// ================================
let lastCargoCode = null;
let waypointActive = false;

// ================================
// SET WAYPOINT
// ================================
function setCargoWaypoint(code, cargoName=""){
  const airport = airports[code?.toUpperCase()];
  if(!airport){
    window.parent.postMessage({type:"notification", text:`⚠️ Unknown airport code: ${code}`},"*");
    updateOverlay(cargoName, `Unknown (${code})`);
    return;
  }

  // Only set waypoint if it's a new cargo OR previous waypoint was cleared
  if(code === lastCargoCode && waypointActive) return;

  lastCargoCode = code;
  waypointActive = true;

  window.parent.postMessage({type:"setWaypoint", x:airport.x, y:airport.y},"*");
  window.parent.postMessage({type:"notification", text:`✈️ Waypoint set: ${airport.name}`},"*");
  updateOverlay(cargoName, airport.name);
}

// ================================
// PROCESS NOTIFICATION
// ================================
function processNotification(text){
  if(!text) return;

  // Ignore notifications sent by our app
  if(text.includes("✈️ Waypoint set:")) return;

  const match = text.match(/Air Cargo:\s*([A-Z]+)/i);
  if(match){
    const airportCode = match[1].toUpperCase();
    setCargoWaypoint(airportCode, "Air Cargo");
  }
}

// ================================
// HANDLE GAME DATA
// ================================
function handleGameMessage(event){
  const msg = event.data.data || event.data || {};

  // Reset waypoint state if cleared manually
  if(msg.waypoint === false) waypointActive = false;

  if(msg.notification && typeof msg.notification === "string"){
    processNotification(msg.notification);
  }

  console.log("Received game data:", msg); // Debug
}

// ================================
// LISTEN FOR GAME MESSAGES
// ================================
window.addEventListener("message", handleGameMessage);

// ================================
// REQUEST LAST CACHED NOTIFICATION ON LOAD
// ================================
window.parent.postMessage({ type: "getNamedData", keys: ["notification","waypoint"] }, "*");

// ================================
// INITIAL OVERLAY
// ================================
updateOverlay(null,null);
</script>
</body>
</html>
