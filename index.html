<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cargo Pilot Auto Waypoint</title>
<style>
body { margin:0; font-family:"Segoe UI", sans-serif; background:transparent; color:white; }
#cargoOverlay {
  position:fixed; top:10px; right:10px;
  background:rgba(0,0,0,0.7); padding:10px 15px;
  border-radius:8px; font-size:14px; z-index:9999;
  pointer-events:auto;
  transition: opacity 0.3s ease;
  cursor: move;
  user-select: none;
}
#version { position:fixed; bottom:10px; right:10px; color:white; font-size:12px; }

/* New â€“ yellow crate button (always visible, above parachute) */
#cargoButton {
  position: fixed;
  bottom: 100px;               /* sits above the parachute button at 60px */
  left: 20px;                  /* aligned with parachute button */
  width: 32px;
  height: 32px;
  cursor: pointer;
  z-index: 9999;
  pointer-events: auto;
  opacity: 0.5;                /* dim when no cargo */
  transition: opacity 0.3s;
}
#cargoButton:hover { opacity: 1; }
#cargoButton.active { opacity: 0.9; }  /* bright when you have cargo */
</style>
</head>
<body>
<div id="cargoOverlay">Waiting for cargo notifications...</div>
<div id="version">v1.7 â€“ crate button added</div>

<!-- New yellow crate button â€“ always visible -->
<div id="cargoButton" title="Click to re-set last cargo waypoint">
  <img src="crate.png" alt="Cargo Crate" style="width:32px; height:32px; display:block;">
</div>

<script>
// ================================
// AUTO CACHE-BUST
// ================================
(function() {
  const url = new URL(window.location.href);
  if (!url.searchParams.has("v")) {
    url.searchParams.set("v", Date.now());
    window.location.replace(url.toString());
  }
})();
// ================================
// AIRPORT COORDINATES (your perfect list)
// ================================
const airports = {
  LSIA: {x: -1422.92, y: -2674.46, z: 13.94, name: "Cargo Airport: LSIA"},
  POP:  {x: 997.78,  y: -3414.56, z: 4.17,  name: "Cargo Airport: PostOp"},
  ZMA:  {x: -2121.92, y: 3133.66, z: 32.28, name: "Cargo Airport: Zancudo"},
  MGA:  {x: 2274.99,  y: 7004.57, z: 20.48, name: "Cargo Airport: Mount Gordo"},
  CIA:  {x: -5340.23, y: 913.90,  z: 11.47, name: "Cargo Airport: Chumash"},
  SSIA: {x: 528.19,   y: 3830.41, z: 32.56, name: "Cargo Airport: Sandy Shores"},
  POC:  {x: 3009.45,  y: -716.82, z: 18.90, name: "Cargo Airport: Pacific Ocean"},
  SCA:  {x: 6352.30,  y: 3554.07, z: 11.47, name: "Cargo Airport: San Chianski"},
  RAM:  {x: -3097.25, y: 7653.29, z: 44.30, name: "Cargo Airport: Roxwood"}
};
// ================================
// UI UPDATE
// ================================
const overlay = document.getElementById('cargoOverlay');
function updateOverlay(cargoName, airportName){
  overlay.innerHTML = cargoName
    ? `Cargo: <b>${cargoName}</b><br>Next: <b>${airportName || 'Unknown'}</b>`
    : 'Waiting for cargo notifications...';
  overlay.style.opacity = 1;
  setTimeout(()=>{ overlay.style.opacity = 0.7; }, 5000);
}
// ================================
// TRACK LAST PROCESSED CARGO & WAYPOINT STATE
// ================================
let lastCargoCode = null;
let waypointActive = false;
let hasActiveCargo = false;  // tracks if we currently have cargo
// ================================
// SET WAYPOINT
// ================================
function setCargoWaypoint(code, cargoName=""){
  const airport = airports[code?.toUpperCase()];
  if(!airport){
    window.parent.postMessage({type:"notification", text:`âš ï¸ Unknown airport code: ${code}`},"*");
    updateOverlay(cargoName, `Unknown (${code})`);
    return;
  }
  if(code === lastCargoCode && waypointActive) return;
  lastCargoCode = code;
  waypointActive = true;
  hasActiveCargo = true;  // mark that we have cargo
  // Save to localStorage
  localStorage.setItem('lastCargoCode', code);
  localStorage.setItem('hasActiveCargo', 'true');
  window.parent.postMessage({type:"setWaypoint", x:airport.x, y:airport.y},"*");
  window.parent.postMessage({type:"notification", text:`âœˆï¸ Waypoint set: ${airport.name}`},"*");
  updateOverlay(cargoName, airport.name);
  document.getElementById('cargoButton').classList.add('active');  // brighten button
}
// ================================
// PROCESS NOTIFICATION
// ================================
function processNotification(text){
  if(!text) return;
  if(text.includes("âœˆï¸ Waypoint set:")) return;
  if(!text.toLowerCase().includes("received")) return;

  const match = text.match(/Air Cargo:\s*([A-Z]+)/i);
  if(match){
    const airportCode = match[1].toUpperCase();
    setCargoWaypoint(airportCode, "Air Cargo");
  }
}
// ================================
// HANDLE GAME DATA
// ================================
function handleGameMessage(event){
  const msg = event.data.data || event.data || {};
  if(msg.waypoint === false){
    waypointActive = false;
    // Keep lastCargoCode so button can re-set it
    // Keep button bright if we still have cargo
    if(hasActiveCargo) document.getElementById('cargoButton').classList.add('active');
  }
  if(msg.notification && typeof msg.notification === "string"){
    processNotification(msg.notification);
  }
  // Handle cached data response on page load
  if(msg.notification && !lastCargoCode){
    const match = msg.notification.match(/Air Cargo:\s*([A-Z]+)/i);
    if(match){
      lastCargoCode = match[1].toUpperCase();
      hasActiveCargo = true;
      document.getElementById('cargoButton').classList.add('active');
      updateOverlay("Air Cargo", airports[lastCargoCode]?.name || "Unknown");
    }
  }
  console.log("Received game data:", msg);
}
// ================================
// LISTEN FOR GAME MESSAGES
// ================================
window.addEventListener("message", handleGameMessage);
// ================================
// PIN WEB APP ON ESCAPE
// ================================
window.addEventListener('keydown', (e) => {
  if (e.key === "Escape") {
    window.parent.postMessage({type: "pin"}, "*");
  }
});
// ================================
// REQUEST LAST CACHED NOTIFICATION ON LOAD
// ================================
window.parent.postMessage({ type: "getNamedData", keys: ["notification","waypoint"] }, "*");
// ================================
// NEW â€“ crate button always visible + click to re-set
// ================================
document.getElementById('cargoButton').addEventListener('click', () => {
  if(lastCargoCode && hasActiveCargo && airports[lastCargoCode]){
    setCargoWaypoint(lastCargoCode, "Air Cargo");
    window.parent.postMessage({type:"notification", text:"ðŸ”„ Cargo waypoint re-set!"}, "*");
  } else {
    window.parent.postMessage({type:"notification", text:"âš ï¸ No active cargo to re-set"}, "*");
  }
});
// ================================
// INITIAL OVERLAY + button starts dim
// ================================
// Restore from localStorage on page load
const savedCargoCode = localStorage.getItem('lastCargoCode');
const savedHasCargo = localStorage.getItem('hasActiveCargo') === 'true';
if(savedCargoCode && savedHasCargo){
  lastCargoCode = savedCargoCode;
  hasActiveCargo = true;
  document.getElementById('cargoButton').classList.add('active');
  updateOverlay("Air Cargo", airports[savedCargoCode]?.name || "Unknown");
} else {
  updateOverlay(null,null);
  document.getElementById('cargoButton').classList.remove('active'); // dim at start
}
// ================================
// MAKE CARGO OVERLAY DRAGGABLE
// ================================
(function() {
  const overlay = document.getElementById('cargoOverlay');
  let isDragging = false;
  let currentX, currentY, initialX, initialY;
  
  // Restore saved position
  const savedX = localStorage.getItem('overlayX');
  const savedY = localStorage.getItem('overlayY');
  if(savedX && savedY) {
    overlay.style.left = savedX + 'px';
    overlay.style.top = savedY + 'px';
    overlay.style.right = 'auto';
  }
  
  overlay.addEventListener('mousedown', (e) => {
    isDragging = true;
    initialX = e.clientX - (parseInt(overlay.style.left) || overlay.offsetLeft);
    initialY = e.clientY - (parseInt(overlay.style.top) || overlay.offsetTop);
  });
  
  document.addEventListener('mousemove', (e) => {
    if(!isDragging) return;
    e.preventDefault();
    currentX = e.clientX - initialX;
    currentY = e.clientY - initialY;
    overlay.style.left = currentX + 'px';
    overlay.style.top = currentY + 'px';
    overlay.style.right = 'auto';
  });
  
  document.addEventListener('mouseup', () => {
    if(isDragging) {
      isDragging = false;
      // Save position
      localStorage.setItem('overlayX', parseInt(overlay.style.left));
      localStorage.setItem('overlayY', parseInt(overlay.style.top));
    }
  });
})();
</script>
</body>
</html>
