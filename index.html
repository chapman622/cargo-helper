<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cargo Pilot Auto Waypoint</title>
<style>
body { margin:0; font-family:"Segoe UI", sans-serif; background:transparent; color:white; }
#cargoOverlay {
  position:fixed; top:10px; right:10px;
  background:rgba(0,0,0,0.7); padding:10px 15px;
  border-radius:8px; font-size:14px; z-index:9999;
  pointer-events:none;
  transition: opacity 0.3s ease;
}
#version { position:fixed; bottom:10px; right:10px; color:white; font-size:12px; }
</style>
</head>
<body>
<div id="cargoOverlay">Waiting for cargo notifications...</div>
<div id="version">v1.6</div>

<script>
// ================================
// AUTO CACHE-BUST
// ================================
(function() {
  const url = new URL(window.location.href);
  if (!url.searchParams.has("v")) {
    url.searchParams.set("v", Date.now());
    window.location.replace(url.toString());
  }
})();

// ================================
// AIRPORT COORDINATES
// ================================
const airports = {
  LSIA: {x: -985.95, y: -2995.50, z: 22.73, name: "Cargo Airport: LSIA"},
  SSIA: {x: 1729.46, y: 3240.20, z: 50.03, name: "Cargo Airport: Sandy Shores (SSIA)"},
  SAN:  {x: 1729.46, y: 3240.20, z: 50.03, name: "Cargo Airport: Sandy Shores Airfield (SAN)"},  // Often same as SSIA
  MKA:  {x: 2119.92, y: 4806.70, z: 49.85, name: "Cargo Airport: McKenzie (MKA)"},
  SCA:  {x: 6231.88, y: 2951.94, z: 20.82, name: "Cargo Airport: San Chianski (SCA)"},
  ZMA:  {x: -2129.56, y: 3132.29, z: 41.65, name: "Cargo Airport: Zancudo (ZMA/ZAN)"},
  CIA:  {x: -4830.09, y: 1063.91, z: 20.79, name: "Cargo Airport: Chumash (CIA)"},
  POA:  {x: 3034.56, y: -1432.00, z: 19.84, name: "Cargo Airport: Pacific Ocean (POA)"},
  PBA:  {x: -3234.13, y: 7392.24, z: 44.59, name: "Cargo Airport: Paleto Bay (PBA/RAM)"},
  MGA:  {x: 2577.80, y: 6652.55, z: 20.51, name: "Cargo Airport: Mount Gordo (MGA)"},
  POP:  {x: 997.18, y: -3415.91, z: 4.70, name: "Cargo Airport: PostOp (POP)"},  // If it appears
  CV:   {x: 3082.31, y: -4719.0, z: 15.26, name: "Aircraft Carrier (CV)"},
  CPA:  {x: 4480.0, y: -4480.0, z: 5.0, name: "Cayo Perico Airfield (CPA)"}
};

// ================================
// UI UPDATE
// ================================
const overlay = document.getElementById('cargoOverlay');
function updateOverlay(cargoName, airportName){
  overlay.innerHTML = cargoName
    ? `Cargo: <b>${cargoName}</b><br>Next: <b>${airportName || 'Unknown'}</b>`
    : 'Waiting for cargo notifications...';
  overlay.style.opacity = 1;
  setTimeout(()=>{ overlay.style.opacity = 0.7; }, 5000);
}

// ================================
// TRACK LAST PROCESSED CARGO & WAYPOINT STATE
// ================================
let lastCargoCode = null;
let waypointActive = false;

// ================================
// SET WAYPOINT
// ================================
function setCargoWaypoint(code, cargoName=""){
  const airport = airports[code?.toUpperCase()];
  if(!airport){
    window.parent.postMessage({type:"notification", text:`⚠️ Unknown airport code: ${code}`},"*");
    updateOverlay(cargoName, `Unknown (${code})`);
    return;
  }

  // Only set waypoint if it's a new cargo OR previous waypoint was cleared
  if(code === lastCargoCode && waypointActive) return;

  lastCargoCode = code;
  waypointActive = true;

  window.parent.postMessage({type:"setWaypoint", x:airport.x, y:airport.y},"*");
  window.parent.postMessage({type:"notification", text:`✈️ Waypoint set: ${airport.name}`},"*");
  updateOverlay(cargoName, airport.name);
}

// ================================
// PROCESS NOTIFICATION
// ================================
function processNotification(text){
  if(!text) return;

  // Ignore notifications sent by our app
  if(text.includes("✈️ Waypoint set:")) return;

  const match = text.match(/Air Cargo:\s*([A-Z]+)/i);
  if(match){
    const airportCode = match[1].toUpperCase();
    setCargoWaypoint(airportCode, "Air Cargo");
  }
}

// ================================
// HANDLE GAME DATA
// ================================
function handleGameMessage(event){
  const msg = event.data.data || event.data || {};

  // Reset waypoint state if cleared manually
  if(msg.waypoint === false){
    waypointActive = false;
    lastCargoCode = null; // <-- only change we added
  }

  if(msg.notification && typeof msg.notification === "string"){
    processNotification(msg.notification);
  }

  console.log("Received game data:", msg); // Debug
}

// ================================
// LISTEN FOR GAME MESSAGES
// ================================
window.addEventListener("message", handleGameMessage);

// ================================
// REQUEST LAST CACHED NOTIFICATION ON LOAD
// ================================
window.parent.postMessage({ type: "getNamedData", keys: ["notification","waypoint"] }, "*");

// ================================
// INITIAL OVERLAY
// ================================
updateOverlay(null,null);
</script>
</body>
</html>
